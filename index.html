<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Senderos FEDME — Mapa (IDEe / vt-fedme)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    body,html,#map { height:100%; margin:0; padding:0; }
    #map { position:relative; }
    .info {
      position:absolute; top:10px; left:10px; z-index: 2;
      background: rgba(255,255,255,0.9); padding:8px; border-radius:6px;
      font-family:Arial, Helvetica, sans-serif; font-size:14px;
      width: 320px;
    }
    .info a {
      color: inherit;
      text-decoration: none;
    }
    .info a:hover {
      text-decoration: underline;
    }
    #route-tooltip {
      position:absolute; z-index:1000; pointer-events:none;
      background:rgba(0,0,0,0.8); color:#fff; padding:4px 8px;
      border-radius:4px; font-size:12px; font-family:Arial,sans-serif;
      display:none; white-space:nowrap;
    }
    #route-popup .card {
      background: rgba(255,255,255,0.9) !important;
    }
    #route-details-popup {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #route-details-popup.show {
      opacity: 1;
      transform: translateY(0);
    }
    #route-details-popup.hide {
      opacity: 0;
      transform: translateY(-10px);
    }
    #route-details-popup .card {
      background: rgba(255,255,255,0.9) !important;
    }
    #route-popup {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #route-popup.show {
      opacity: 1;
      transform: translateY(0);
    }
    #route-popup.hide {
      opacity: 0;
      transform: translateY(-10px);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info">
    <strong>Senderos <a href="https://misendafedme.es/" target="_blank" rel="noopener">FEDME</a></strong><br>
    Clic en una ruta para ver propiedades y enlaces.
  </div>
  <div id="route-tooltip"></div>
  <div id="route-details-popup"></div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // Usar el style original de IDEE para que las rutas se vean correctamente
    const styleUrl = 'https://vt-fedme.idee.es/files/styles/style.json';

    const map = new maplibregl.Map({
      container: 'map',
      style: styleUrl,
      center: [-3.7, 40.4],
      zoom: 6
    });

    map.addControl(new maplibregl.NavigationControl({showCompass:false}), 'top-right');

    // Cuando el mapa cargue, añade la capa raster de satélite debajo de las rutas
    map.on('load', () => {
      // Añade la fuente raster de ESRI
      map.addSource('esri-satellite', {
        type: 'raster',
        tiles: [
          'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        ],
        tileSize: 256,
        attribution: '© ESRI, Earthstar Geographics'
      });
      // Inserta la capa raster justo debajo de la primera capa de rutas
      const layers = map.getStyle().layers;
      let firstLineLayer = layers.find(l => l.type === 'line');
      let beforeId = firstLineLayer ? firstLineLayer.id : undefined;
      map.addLayer({
        id: 'satellite',
        type: 'raster',
        source: 'esri-satellite',
        minzoom: 0,
        maxzoom: 18
      }, beforeId);
      map.addSource('fedme', {
        type: 'vector',
        url: 'https://vt-fedme.idee.es/files/services/senderos.json'
      });
      map.addLayer({
        id: 'fedme-rutas',
        type: 'line',
        source: 'fedme',
        'source-layer': 'senderos-fedme',
        paint: {
          'line-color': '#e74c3c',
          'line-width': 3
        }
      });
      // Capa para resaltar la ruta seleccionada
      map.addLayer({
        id: 'fedme-rutas-selected',
        type: 'line',
        source: 'fedme',
        'source-layer': 'senderos-fedme',
        paint: {
          'line-color': '#c0392b',
          'line-width': 6
        },
        filter: ['==', 'id', ''] // Inicialmente vacío, no muestra nada
      });
      map.getCanvas().style.cursor = 'default';
    });

    // Helper: construye HTML con propiedades y (si existe) enlaces a gpx/kml
    function featurePopupHtml(props) {
      let html = `<div style="font-family:Arial,Helvetica,sans-serif;font-size:13px">`;
      // Muestra un par de propiedades relevantes (no conocemos nombres exactos).
      for (const k of ['nombre','name','id','tipo','clasificacion','longitud']) {
        if (props[k]) {
          html += `<b>${k}:</b> ${props[k]}<br>`;
        }
      }
      html += `<hr style="margin:6px 0">`;

      // Busca propiedades típicas que podrían contener enlaces (si vienen en las tiles)
      const possibleUrlKeys = ['gpx','gpx_url','kml','kml_url','url','download'];
      let found = false;
      for (const key of possibleUrlKeys) {
        if (props[key]) {
          html += `<a href="${props[key]}" target="_blank" rel="noopener">Descargar (${key})</a><br>`;
          found = true;
        }
      }

      if (!found) {
        // Si no hay enlace directo: redirige al Centro de Descargas del CNIG (lista KML/GPX)
        html += `Enlace de descarga no disponible en la tesela.<br>
                 <a href="https://centrodedescargas.cnig.es/CentroDescargas/senderos-fedme" target="_blank" rel="noopener">
                   Buscar KML/GPX en CentroDescargas (CNIG)
                 </a>`;
      }
      html += `</div>`;
      return html;
    }

    // Popup global
    const popup = new maplibregl.Popup({closeButton:true,closeOnClick:true});

    // Variable para trackear la ruta seleccionada
    let selectedRouteId = null;

    // Popup global fijo en la esquina superior izquierda
    const popupDiv = document.createElement('div');
    popupDiv.id = 'route-popup';
    popupDiv.style.position = 'absolute';
    popupDiv.style.left = '10px';
    popupDiv.style.top = '78px';
    popupDiv.style.zIndex = '1000';
    popupDiv.style.width = '320px';
    popupDiv.style.height = '354px';
    popupDiv.style.display = 'none';
    document.body.appendChild(popupDiv);

    // Panel de detalles adicionales (debajo del panel de información)
    const detailsPopupDiv = document.createElement('div');
    detailsPopupDiv.id = 'route-details-popup';
    detailsPopupDiv.style.position = 'absolute';
    detailsPopupDiv.style.left = '10px';
    detailsPopupDiv.style.top = '444px'; // Debajo del panel principal (354 + 78 + 10px gap)
    detailsPopupDiv.style.zIndex = '1000';
    detailsPopupDiv.style.width = '320px';
    detailsPopupDiv.style.maxHeight = 'calc(100vh - 454px)'; // Altura máxima disponible
    detailsPopupDiv.style.display = 'none';
    document.body.appendChild(detailsPopupDiv);

    // Función para buscar imagen en Google Images
    async function searchRouteImage(routeName) {
      try {
        // Limpiar el nombre para la búsqueda
        const cleanName = routeName.replace(/[.-]/g, ' ').trim();
        const searchQuery = encodeURIComponent(`${cleanName} sendero ruta senderismo España`);
        
        // Usar una búsqueda alternativa via SerpApi (requiere API key) o método alternativo
        // Por simplicidad, usaremos una búsqueda básica que puede funcionar
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const googleSearchUrl = `https://www.google.com/search?q=${searchQuery}&tbm=isch&tbs=isz:m`; // isz:m para imágenes medianas
        
        const response = await fetch(proxyUrl + encodeURIComponent(googleSearchUrl));
        const data = await response.json();
        
        // Buscar URLs de imágenes en el HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        
        // Buscar imágenes en los resultados (esto es muy básico)
        const images = doc.querySelectorAll('img[src*="http"]');
        
        for (let img of images) {
          const src = img.getAttribute('src');
          if (src && src.includes('http') && !src.includes('logo') && !src.includes('icon') && 
              !src.includes('avatar') && src.length > 50) { // URLs más largas suelen ser de mejor calidad
            return src;
          }
        }
        
        return null;
      } catch (error) {
        console.log('Error buscando imagen:', error);
        return null;
      }
    }
    async function loadRouteDetails(url) {
      try {
        // Intentar usar un proxy CORS gratuito
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const response = await fetch(proxyUrl + encodeURIComponent(url));
        const data = await response.json();
        
        // Crear un parser DOM
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        
        // Buscar los divs específicos con las clases requeridas
        const blocInfo1 = doc.querySelector('.blocInfo1.blocInfo');
        const blocInfo2 = doc.querySelector('.blocInfo2.blocInfo');
        
        let combinedContent = '';
        
        if (blocInfo1) {
          combinedContent += blocInfo1.outerHTML;
        }
        
        if (blocInfo2) {
          combinedContent += blocInfo2.outerHTML;
        }
        
        if (combinedContent) {
          // Crear un elemento temporal para procesar el contenido
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = combinedContent;
          
          // Eliminar todas las imágenes
          const images = tempDiv.querySelectorAll('img');
          images.forEach(img => img.remove());
          
          // Ajustar tamaños de títulos
          const h1s = tempDiv.querySelectorAll('h1');
          h1s.forEach(h1 => {
            h1.style.fontSize = '14px';
            h1.style.fontWeight = 'bold';
          });
          
          const h2s = tempDiv.querySelectorAll('h2');
          h2s.forEach(h2 => {
            h2.style.fontSize = '14px';
            h2.style.fontWeight = 'bold';
          });
          
          const h3s = tempDiv.querySelectorAll('h3');
          h3s.forEach(h3 => {
            h3.style.fontSize = '14px';
            h3.style.fontWeight = 'bold';
          });
          
          const h4s = tempDiv.querySelectorAll('h4');
          h4s.forEach(h4 => {
            h4.style.fontSize = '14px';
            h4.style.fontWeight = 'bold';
          });
          
          return tempDiv.innerHTML;
        }
        
        return null;
      } catch (error) {
        console.log('Error cargando detalles de la ruta:', error);
        return null;
      }
    }

    // Escucha clicks en el mapa y muestra propiedades de la primera feature visible
    map.on('click', async (e) => {
      // Buscar features en todas las capas
      const allFeatures = map.queryRenderedFeatures(e.point);
      const routeFeatures = allFeatures.filter(f => {
        const props = f.properties || {};
        return props.nombre || props.name || props.id;
      });
      
      if (!routeFeatures || routeFeatures.length === 0) {
        // Click fuera de una ruta - quitar selección con animación
        selectedRouteId = null;
        map.setFilter('fedme-rutas-selected', ['==', 'id', '']);
        
        // Ocultar panel principal
        popupDiv.classList.remove('show');
        popupDiv.classList.add('hide');
        setTimeout(() => {
          popupDiv.style.display = 'none';
          popupDiv.classList.remove('hide');
        }, 300);
        
        // Ocultar panel de detalles
        detailsPopupDiv.classList.remove('show');
        detailsPopupDiv.classList.add('hide');
        setTimeout(() => {
          detailsPopupDiv.style.display = 'none';
          detailsPopupDiv.classList.remove('hide');
        }, 300);
        
        return;
      }
      
      const feat = routeFeatures[0];
      const props = feat.properties || {};
      
      // Resaltar la ruta seleccionada
      selectedRouteId = props.id;
      if (selectedRouteId) {
        map.setFilter('fedme-rutas-selected', ['==', 'id', selectedRouteId]);
      }
      
      let html = `
        <div class="card border-0 h-100 d-flex flex-column">
          <div class="card-header bg-primary text-white py-2">
            <h6 class="mb-0"><i class="fas fa-route me-2"></i>Información de la Ruta</h6>
          </div>
          <div class="card-body p-3 d-flex flex-column" style="height: calc(100% - 50px);">
            <div class="flex-grow-1">`;
      
      // Añadir título con el nombre simplificado de la ruta
      let nombre = props.nombre || props.name || '';
      let nombreSimple = nombre.split('.')[0].trim();
      if (nombreSimple) {
        html += `
          <div class="mb-3">
            <h5 class="fw-bold text-primary mb-1">${nombreSimple}</h5>
          </div>
        `;
      }
      
      for (const k of ['nombre','id','longitud']) {
        if (props[k]) {
          let label = k.charAt(0).toUpperCase() + k.slice(1);
          let value = props[k];
          if (k === 'longitud') {
            label = 'Longitud';
            value = `${props[k]} km`;
          }
          html += `
            <div class="mb-2">
              <small class="text-muted">${label}:</small><br>
              <span class="fw-medium">${value}</span>
            </div>
          `;
        }
      }
      
      html += `</div>`; // Cerrar flex-grow-1
      
      // Enlaces de descarga como botones en la parte inferior - SIEMPRE pegados abajo
      const possibleUrlKeys = ['gpx','kml','url','download'];
      let found = false;
      let downloadButtons = '';
      
      for (const key of possibleUrlKeys) {
        if (props[key]) {
          downloadButtons += `
            <a href="${props[key]}" target="_blank" rel="noopener" 
               class="btn btn-outline-success btn-sm me-2 mb-2">
              <i class="fas fa-download me-1"></i>${key.toUpperCase()}
            </a>
          `;
          found = true;
        }
      }
      
      if (found) {
        html += `
          <div class="mt-auto">
            <hr class="my-2">
            <div>
              <small class="text-muted d-block mb-2">Descargar:</small>
              <div class="d-flex justify-content-between">
                <div class="d-flex flex-wrap">
                  ${downloadButtons}
                </div>`;
        
        // Botón de información adicional si existe - alineado con los botones
        if (props.url_info) {
          html += `
                <div class="d-flex align-items-start">
                  <a href="${props.url_info}" target="_blank" rel="noopener" 
                     class="btn btn-outline-info btn-sm">
                    <i class="fas fa-info-circle me-1"></i>INFO
                  </a>
                </div>`;
        }
        
        html += `
              </div>
            </div>
          </div>`;
      } else {
        html += `
          <div class="mt-auto">
            <hr class="my-2">
            <div class="text-center">
              <small class="text-muted">Enlace directo no disponible</small><br>
              <a href="https://centrodedescargas.cnig.es/CentroDescargas/senderos-fedme" 
                 target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm mt-2">
                <i class="fas fa-external-link-alt me-1"></i>Centro de Descargas CNIG
              </a>
            </div>
          </div>
        `;
      }
      
      html += `
          </div>
        </div>
      `;
      popupDiv.innerHTML = html;
      popupDiv.style.display = 'block';
      // Forzar reflow para que la transición funcione
      popupDiv.offsetHeight;
      popupDiv.classList.add('show');
      
      // Cargar detalles adicionales si hay URL de información
      if (props.url_info) {
        detailsPopupDiv.innerHTML = `
          <div class="card border-0">
            <div class="card-header bg-info text-white py-2">
              <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Detalles Adicionales</h6>
            </div>
            <div class="card-body p-3 d-flex justify-content-center align-items-center">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 mb-0"><small class="text-muted">Cargando información adicional...</small></p>
              </div>
            </div>
          </div>
        `;
        detailsPopupDiv.style.display = 'block';
        detailsPopupDiv.offsetHeight;
        detailsPopupDiv.classList.add('show');
        
        // Cargar detalles e imagen de forma paralela
        const [detailsHtml, imageUrl] = await Promise.all([
          loadRouteDetails(props.url_info),
          searchRouteImage(nombreSimple)
        ]);
        
        if (detailsHtml || imageUrl) {
          let contentHtml = '';
          
          // Añadir imagen si se encontró
          if (imageUrl) {
            contentHtml += `
              <div class="mb-3">
                <img src="${imageUrl}" alt="${nombreSimple}" class="img-fluid rounded" 
                     style="max-height: 180px; width: 100%; object-fit: cover; object-position: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"
                     onerror="this.style.display='none';">
              </div>
            `;
          }
          
          // Añadir detalles si existen
          if (detailsHtml) {
            if (imageUrl) contentHtml += '<hr class="my-2">';
            contentHtml += detailsHtml;
          }
          
          detailsPopupDiv.innerHTML = `
            <div class="card border-0">
              <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Detalles Adicionales</h6>
              </div>
              <div class="card-body p-3" style="max-height: calc(100vh - 500px); overflow-y: auto; font-size: 12px;">
                ${contentHtml}
              </div>
            </div>
          `;
        } else {
          detailsPopupDiv.innerHTML = `
            <div class="card border-0">
              <div class="card-header bg-warning text-white py-2">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Sin Detalles</h6>
              </div>
              <div class="card-body p-3 d-flex justify-content-center align-items-center">
                <div class="text-center">
                  <small class="text-muted">No se pudieron cargar los detalles adicionales ni imagen</small><br>
                  <small class="text-muted">Haz clic en el botón INFO para ver la información completa</small>
                </div>
              </div>
            </div>
          `;
        }
      }
    });

    // Cambia cursor cuando hay features al pasar por encima
    map.on('mousemove', (e) => {
      // Buscar features en todas las capas, luego filtrar por tipo
      const features = map.queryRenderedFeatures(e.point);
      const routeFeatures = features.filter(f => {
        // Buscar features que contengan propiedades típicas de rutas FEDME
        const props = f.properties || {};
        return props.nombre || props.name || props.id;
      });
      
      map.getCanvas().style.cursor = (routeFeatures && routeFeatures.length) ? 'pointer' : '';
      
      // Tooltip para mostrar código de ruta
      const tooltip = document.getElementById('route-tooltip');
      if (routeFeatures && routeFeatures.length > 0) {
        const feat = routeFeatures[0];
        const props = feat.properties || {};
        let nombre = props.nombre || props.name || '';
        // Extraer solo la parte del código (ej: "GR 10" de "GR 10. Etapa 08. Abejuela-Arcos de las Salinas")
        let codigo = nombre.split('.')[0].trim();
        if (codigo) {
          tooltip.innerHTML = codigo;
          tooltip.style.display = 'block';
          tooltip.style.left = (e.originalEvent.pageX + 10) + 'px';
          tooltip.style.top = (e.originalEvent.pageY - 25) + 'px';
        }
      } else {
        tooltip.style.display = 'none';
      }
    });

  </script>
</body>
</html>
